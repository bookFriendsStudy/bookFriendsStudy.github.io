# 14장

# 유튜브 설계

## 개략적 규모

- DAU : 500만
- 한 사용자는 하루 평균 5개 비디오 시청
- 10%의 사용자가 하루에 1비디오 업로드
- 비디오 평균 크기는 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량 150TB

설계는 크게 두가지 영역으로 진행된다.

- 비디어 업로드
- 비디로 시청(스트리밍)

## 비디오 업로드 절차


- 사용자: 컴퓨터나 모바일 폰, 혹은 스마트 TV를 통해 유튜브를 시청하는 이용자다.
- 로드밸런서(load balancer): API 서버 각각으로 고르게 요청을 분산하는 역할을 담당한다.
- API 서버: 비디오 스트리밍을 제외한 다른 모든 요청을 처리한다. 메타데이터 데이터베이스(metadata db): 비디오의 메타데이터를 보관한다.
- 메타데이터 캐시(metadata cache): 성능을 높이기 위해 비디오 메타데이터 와 사용자 객체 (user object)는 캐시 한다.
- 원본 저장소(original storage): 원본 비디오를 보관할 대형 이진 파일 저장소 (BLOB, 즉 Binary Large Object storage) 시스템이다.
- 트랜스코딩 서버(transcoding server): 비디오의 포맷(MPEG, HLS 등)을 변환하는 절차다. 단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림을 제공하기 위해 필요하다.
- 트랜스코딩 비디오 저장소(transcoded storage): 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소다.
- CDN: 비디오를 캐시하는 역할을 담당한다. 사용자가 재생 버튼을 누르면 비디오 스트리밍은 CDN을 통해 이루어진다.
- 트랜스코딩 완료 큐 : 비디오 트랜스코딩 완료 이벤트를 보관한다.
- 트랜스코딩 완료 핸들러 : 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내 메타데이터 캐시와 DB를 갱신한다.

비디오 업로드는 크게 두가지의 프로세스가 병렬적으로 수행된다.

### 프로세스 a: 비디오 업로드

1. 비디오를 원본 저장소에 저장한다.
2. 트랜스코딩 서버가 원본 저장소에서 비디오를 가져와 트랜스코딩을 시작한다.
3. 트랜스 코딩이 완료되면 완료된 비디오를 트랜스코딩 비디오 저장소에 저장하며 이벤트를 큐에 넣는다.
4. 트랜스코딩 완료 핸들러가 메타데이터 캐시와 DB를 갱신한다.
5. API서버가 단말에게 비디오 업로드가 끝났음을 알린다.

### 프로세스 b: 메타데이터 갱신

원본저장소에 파일이 업로드 되는 동안 단말은 병렬적으로 비디오 메타데이터 갱신요청을 API서버를 통해 보낸다.

여기에는 이름, 크기, 포맷등 비디오의 메타데이터를 담고 있고 이를 캐시와 DB에 저장한다.

## 비디오 스트리밍 절차

비디오 재생버튼을 눌렀을때 스트리밍은 시작된다. 이때, 영상 전체를 다운로드 한다음 시청하는 것이 아니라 원격지의 비디오로부터 지속적으로 비디오 스트림을 전송 받아 영상을 재생하게 된다.

이때 스트리밍 프로토콜이 사용되는데 이는 비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신방법이다. 다음과 같은 프로토콜이 존재한다.

- MPEG
- HTTP Live Streaming (HLS)
- Microsoft Smooth Streaming
- Adobe HTTP Dynamic Streaming (HDS)

각 프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다. 따라서, 스트리밍 서비스를 설계할 땐 서비스의 용례에 맞는 프로토콜을 잘 선택해야 한다.

비디오는 CDN을 통해 단말에 가장 가까운 지역에서 데이터를 받게 된다.

## 비디오 트랜스코딩

우리가 단말에서 비디오를 녹화하면 해당 비디오를 특정 포맷으로 저장하게 된다.

그리고 이 비디오가 다른 단말에서도 잘 재생되려면 다른 단말과 호환되는 비트레이트와 포맷으로 저장되야 한다.

트랜스코딩은 다음과 같은 이유때문에 필요하다.

- 원본 비디오는 저장공간을 많이 차지한다.
- 상당수의 단말과 브라우저는 특정 종류의 포맷만 지원한다. 따라서, 호환성 문제를 위해 여러 포맷으로 인코딩해야 한다.
- 사용자에게 끊김 없는 고화질 비디오 재생을 보장하려면 사용자의 네트워크 대역폭에 따라 비디오의 품질을 조절할 수 있어야 한다.
- 모바일 단말에서 네트워크 상황이 변경되었을 때 끊김없이 재생되도록 비디오 화질을 자동으로 변경하거나 변경할 수 있도록 해야 한다.

인코딩 포맷은 다양하다. 대부분은 다음 두 부분으로 구성되어 있다.

- 컨테이너 : 비디오파일, 오디오, 메타데이터를 담는 바구니이다. `.avi` `.mov` `.mp4` 와 같은 확장자이다.
- 코덱 : 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 압축해제 알고리즘이다.
`H.264` , `HEVC` 등이 있다.

### 유향 비순환 그래프(DAG) 모델

비디오를 트랜스코딩하는 것은 컴퓨팅 자원과 시간을 많이 소모한다.

각기 다른 유형의 비디오 프로세싱 파이프라인을 지원하며 처리 과정의 병렬성을 높여야 하는데 페이스북의 스트리밍 비디오 엔진은 DAG 프로그래밍 모델을 도입했다.

작업을 단계별로 배열할 수 있도록 하여 해당 작업들이 순차적, 또는 병렬적으로 실행될 수 있도록 한다.


위처럼 파이프라인을 가지며 비디오에서는 다음과 같은 작업을 거친다.

- 검사 : 비디오에 문제가 없는지 확인한다.
- 인코딩 : 비디오를 다양한 해상도, 코덱, 비트레이트 조합으로 인코딩한다. 이를 마치면 각 해상도별 비디오를 얻을 수 있다.
- 섬네일 : 사용자가 업로드한 이미지나 비디오에서 자동 추출된 이미지로 섬네일을 만든다.
- 워터마크 : 비디오에 대한 식별정보를 이미지 위에 오버레이 형태로 띄워 표시한다.


위와같은 아키텍처를 통해 비디오가 만들어진다.

### 전처리기

- 비디오 분할 : 비디오 스트림을 GOP라고 불리는 단위로 쪼갠다. 하나의 GOP는 독립적으로 재생 가능하며 보통 몇초 정도의 길이를 가진다.
- DAG 생성 : 클라이언트 프로그래머가 생성한 파일에 따라 DAG를 생성한다.
- 데이터 캐시 : GOP와 메타데이터를 임시 저장소에 보관한다.

### DAG 스케줄러

- DAG그래프를 여러개의 stage로 분할한 다음 그 각각을 자원관리자의 작업큐에 넣는다.


### 자원관리자

- 자원 배분을 효과적으로 수행하는 역할이다.


- 작업을 선택하고,
- 최적의 작업 서버를 선택하고,
- 실행큐에 현재 실행중인 작업 및 작업 서버 정보를 보관한다.

### 작업 서버

- DAG에 정의된 작업을 수행한다. (인코딩, 워터마크, 섬네일 등)

### 인코딩된 비디오

- 인코딩 파이프라인을 거친 최종 결과물이다. `funny_720p.mp4` 와 같은 이름을 가진다.

## 시스템 최적화

위 설계를 속도, 안정성, 비용 측면에서 최적화 하자.

### 속도 최적화: 비디오 병렬 업로드

- 비디오를 한번에 업로드하는것은 비효율적이다.
- 전처리기에서 분할한 GOP단위로 병렬적으로 업로드한다.
- 설사 일부가 실패하더라도 빠르게 업로드를 재개할 수 있다.

### 속도 최적화: 업로드 센터를 사용자 근거리에 지정

- 업로드 센터를 여러 지역에 둔다.
- 사용자와 가까운 업로드 센터로 데이터를 업로드한다.

### 속도 최적화: 모든 절차를 병렬화

- 느슨하게 결합된 시스템을 만들어 병렬성을 높인다.
- 기존 설계에서는 다운로드 모듈의 작업이 끝나야 인코딩 모듈 작업을 할 수 있었다.
- 이를 메시지 큐를 통해 도입하여 병렬화 할 수 있다.


- 각각의 모듈은 앞선 작업을 기다리지 않고, 작업 큐에서 작업을 꺼내 처리하기만 하면 된다.

### 안정성 최적화: 미리 사인된 업로드 URL

- 허가받은 사용자만이 올바른 저장소에 비디오를 업로드 할 수 있어야 한다.
- 사용자는 업로드 요청을 통해 미리 사인된 URL을 받는다.
- 클라이언트는 해당 URL이 가리키는 위치에 비디오를 업로드한다.

일반적인 업로드 절차는 다음과 같다.


서버에서 권한을 체크한 후에 서버를 통해 저장소에 업로드를 하게 된다.

즉, 바로 저장소로 저장을 하면 되는데 굳이 서버를 거쳐 저장을 하게 된다.

이 문제를 해결하기 위해, 클라이언트는 서버로부터 업로드 요청을 보내면 서버는 클라이언트의 권한을 체크한 뒤에, 저장소에 바로 데이터를 업로드할 수 있는 URL (pre-signed url)을 내려준다.


이후 해당 URL을 통해 클라이언트에서 저장소로 바로 업로드를 할 수 있다.

pre-signed url은 만료기한이 존재하여 해당 만료기간이 지나면 URL로 업로드가 불가능하다.

### 안정성 최적화: 비디오보호

비디오 저작권을 보호하기 위한 방법이다.

- DRM 시스템 도입
- AES 암호화
- 워터마크

등의 방법을 사용할 수 있다.

### 비용 최적화

CDN은 비싸다. 비용을 낮추는게 중요하다.

유튜브의 비디오 스트리밍은 롱테일 분포를 따른다. 즉, 인기 있는 비디오는 빈번히 재생되는 반면 나머지는 거의 보는사람이 없다. 이를 통해 최적화가 가능하다.

- 인기 비디오는 CDN을 통해 재생하되 다른 비디오는 비디오 서버를 통해 재생한다.
- 인기가 별로 없는 비디오는 인코딩 할 필요가 없을 수 있다.
- 어떤 비디오는 특정 지역에서만 인기가 높을 수 있다. 이는 굳이 다른 지역에 옮기지 않아도 된다.
- CDN을 직접 구축하고 ISP와 제휴?

### 오류처리

- 회복가능오류 : 재시도 한다.
- 회복불가능오류 : 작업을 중단하고 클라이언트에게 적절한 오류를 반환한다.

## 마무리

- 라이브 스트리밍의 경우 응답지연이 더 낮아야 한다. 따라서 프로토콜 선정에 유의하자.
- 라이브 스트리밍의 경우 병렬화의 필요성은 떨어지게 된다.
- 라이브 스트리밍의 경우 오류처리 방법을 달리해야한다. 너무 많은 시간이 걸리는 방법은 어렵다.