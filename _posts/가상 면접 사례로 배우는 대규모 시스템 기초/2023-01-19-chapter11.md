---
layout: post
title: 11. 뉴스 피드 시스템 설계
date: 2023-01-19 21:00:00 +0900
categories:
- 가상 면접 사례로 배우는 대규모 시스템 기초
author: jjonyo
---

# 11장

# 뉴스 피드 시스템 설계

<aside>
💡 뉴스피드란?
홈 페이지 중앙에 지속적으로 업데이트 되는 스토리 (페이스북, 인스타의 피드)

</aside>

## 문제 이해 및 설계 범위 확정

- 모바일 앱, 웹 둘다 지원해야 한다.
- 사용자는 뉴스 피드 페이지에 새로운 스토리를 올릴 수 있어야하고 볼 수 있어야 한다.
- 시간 흐름 역순으로 표시된다. (최신것이 위에)
- 한명의 사용자는 최대 5000명의 친구를 가질 수 있다.
- 매일 천만명의 트래픽을 가진다.
- 스토리에 이미지나 비디오 등의 미디어 파일이 포함될 수 있다.

## 개략적 설계

### 뉴스피드 API

HTTP프로토콜을 기반으로 상태 정보를 업데이트하거나, 뉴스피드를 가져오거나, 친구를 추가하는 등 다양한 작업을 수행한다.

### 피드 발행


1. 사용자가 단말을 통해 웹/앱에 접속하고, 단말은 데이터를 저장하기 위해 HTTP 요청을 보낸다.
2. 사용자의 요청은 로드밸런서를 통해 적절한 웹서버에 전달된다.
3. 웹서버는 요청의 종류에 따라 적절한 내부 서비스로 중계한다.
4. 포스팅 저장서비스를 통해 데이터를 저장하고, 새 포스팅을 친구의 뉴스피드에 푸시한다.
5. 알림 서비스는 친구들에게 새 포스팅에 대한 알림을 보낸다.

### 뉴스 피드 생성(포스팅 읽기)


1. 사용자는 피드 읽기 API요청을 보낸다.
2. 로드밸런서를 통해 적절한 웹서버로 요청을 분산한다.
3. 웹서버는 뉴스피드 서비스로 요청을 중계한다.
4. 뉴스피드의 캐시에서 포스팅을 가져온다.

## 상세 설계


이 구조에서 중요한 역할을 하는 컴포넌트는 `웹서버` 와 `포스팅 전송(팬아웃) 서비스` 이다.

### 웹서버

- 클라이언트와 통신한다.
- 인증이나 처리율 제한등의 기능을 수행한다.(인증 토큰을 통한 검증)
- 어뷰징을 막기위해 포스팅 수의 제한을 두는 등의 처리를 한다.

### 포스팅 전송(팬아웃) 서비스

- 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달한다.

**쓰기시점에 팬아웃하는 모델**

- 새로운 포스팅을 기록하는 시점에 뉴스 피드를 갱신한다.
- 즉, 포스팅이 완료되면 바로 해당 사용자의 캐시에 해당 포스팅을 기록한다.
- 장점
    - 뉴스피드가 실시간으로 갱신되며 친구에게 즉시 전송된다.
    - 포스팅을 기록하는 순간 뉴스피드가 갱신되므로 읽는데 드는 시간이 짧아진다.
- 단점
    - 친구가 많은 사용자의 경우 친구목록을 가져오고 그 목록에 있는 모두의 뉴스피드를 갱신하는데 많은 시간이 소요될 수 있다. (그래서 트위터에서 유명인의 경우 별도의 로직을 적용한다고 본것 같기도.. [https://d2.naver.com/helloworld/551588](https://d2.naver.com/helloworld/551588))
    - 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신해야하므로 리소스가 낭비될 수 있다.

**읽기시점에 팬아웃하는 모델**

- 피드를 읽어야 하는 시점에 뉴스피드를 갱신하여 요청 기반(on-demand) 모델이다.
- 장점
    - 비활성화된 사용자, 서비스를 거의 이용하지 않는 사용자는 이 모델이 유리하다.
    - 데이터를 친구 각각에 푸시하는 작업이 필요없다. (핫키문제 X)
- 단점
    - 뉴스피드를 읽는데 많은 시간이 소요될 수 있다.

---

이 설계에서는 두가지 방법을 결합한다.

- 대부분의 사용자는 쓰기시점에 팬아웃(푸시 모델)을 사용한다.
- 친구나 팔로어가 많은 사용자는 읽기시점에 팬아웃(풀 모델)을 사용한다.
- 안정해시를 통해 요청과 데이터를 고르게 분산하여 핫키 문제를 줄인다.


### 포스팅 전송 동작 방식

1. 그래프 데이터베이스에서 친구 ID 목록을 가져온다.
2. 사용자 정보 캐시에서 친구들의 정보를 가져온다.
3. 사용자의 설정에 따라 필터링한다.(피드 무시 설정, 일부공유 등)
4. 친구 목록과 새 스토리의 포스팅 ID를 메시지큐에 넣는다.
5. 팬아웃작업 서버가 메시지큐에서 데이터를 꺼내 뉴스피드 캐시에 넣는다.
    1. 뉴스피드 캐시는 <포스팅ID, 사용자ID>의 구조를 가진 매핑테이블이다.
    2. 메모리크기를 적정수준으로 유지하기 위해 ID만 관리한다.

> 그래프 데이터베이스는 NoSQL계열의 데이터베이스로 관계를 저장하고 탐색하도록 특별히 구축되어 있다.
> 

### 피드 읽기 동작방식


1. 사용자가 뉴스피드를 읽으려는 요청을 보낸다.
2. 로드밸런서를 거쳐 웹서버는 뉴스 피드 서비스를 호출한다.
3. 뉴스피드 서비스는 뉴스피드 캐시에서 포스팅ID 목록을 가져온다.
4. 뉴스피드에 표시할 사용자 정보와 포스팅 정보를 캐시에서 가져온다.
5. 생성된 뉴스피드를 클라이언트에게 보낸다.

<aside>
💡 이 책에서는 푸시모델로 설명하고 있다.

</aside>

### 캐시구조


- 뉴스 피드 : 뉴스피드의 ID를 보관한다.
- 콘텐츠 : 포스팅 데이터를 보관하고 인기 콘텐츠는 따로 보관한다.
- 소셜 그래프 : 사용자 간 관계 정보를 보관한다. (팔로워, 팔로잉)
- 행동 : ‘좋아요’나 댓글 같은 사용자 행위에 관한 정보를 보관한다.
- 횟수 : ‘좋아요’ 횟수, 응답 수, 팔로워 수, 팔로잉 수 등의 정보를 보관한다.

## 마무리

이 설계안은 크게 뉴스피드의 발행(포스팅 생성)과 뉴스피드의 생성(포스팅 읽기)으로 구성되어 있다.

### 논의하면 좋을 만한 주제

### 데이터베이스 규모 확장

- 수직적 규모 확장 vs 수평적 규모 확장
- SQL vs NoSQL
- 주-부 데이터베이스 다중화
- 복제본에 대한 읽기 연산
- 일관성 모델
- 데이터베이스 샤딩

### 이 외 주제

- 웹 계층을 무상태로 운영하기
- 가능한 한 많은 데이터를 캐시할 방법
- 여러 데이터 센터를 지원할 방법
- 메시지 큐를 사용하여 컴포넌트 사이의 결합도 낮추기
- 핵심 메트릭에 대한 모니터링.
    - 트래픽이 몰리는 시간대의 QPS, 사용자 피드를 새로고침할 때의 지연시간
    

결국 Pull 모델을 사용하냐, Push 모델을 사용하느냐가 중요한 요소일 것 같다.

오래된 글이지만 [https://d2.naver.com/helloworld/551588](https://d2.naver.com/helloworld/551588) 를 읽으면 많이 도움이 될 것 같다.

(나도 아직 안읽음)